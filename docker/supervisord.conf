; =============================================================================
; Supervisor Configuration for DDoS Defense System
; =============================================================================
; Manages two main processes:
;   1. xdp-controller - Loads XDP program and handles Redis messages
;   2. ml-pipeline    - NFStream capture piped to ML inference
; =============================================================================

[supervisord]
nodaemon=true
logfile=/app/logs/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/app/logs
user=root

; =============================================================================
; XDP Controller
; =============================================================================
; Loads XDP program onto network interface, manages IP blacklist,
; listens for attack signals from Redis, logs drops to Elasticsearch
; =============================================================================
[program:xdp-controller]
command=python3 -u /app/xdp_controller.py
directory=/app
autostart=true
autorestart=true
startsecs=5
startretries=3
stopwaitsecs=10
stdout_logfile=/app/logs/xdp_controller.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/xdp_controller_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=PYTHONUNBUFFERED="1"
priority=100

; =============================================================================
; ML Pipeline (NFStream -> ML Inference)
; =============================================================================
; Captures packets via NFStream, extracts features, classifies with AdaBoost,
; publishes attacks to Redis, indexes all flows to Elasticsearch
; =============================================================================
[program:ml-pipeline]
command=bash -c "python3 -u /app/nfstream_agent.py | python3 -u /app/ml_infer_service.py"
directory=/app
autostart=true
autorestart=true
startsecs=10
startretries=3
stopwaitsecs=10
stdout_logfile=/app/logs/ml_pipeline.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=5
stderr_logfile=/app/logs/ml_pipeline_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=5
environment=PYTHONUNBUFFERED="1"
; Start after XDP controller is ready
priority=200

; =============================================================================
; Group for easy management
; =============================================================================
[group:ddos-defense]
programs=xdp-controller,ml-pipeline
priority=999

